<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ilumina Tus Sentimientos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563EB;
            --secondary: #60A5FA;
            --accent: #D97706;
            --light: #FEFEFE;
            --dark: #1F2937;
            --text: #374151;
            --background: #ffffff;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --button-primary: #2563EB;
            --button-secondary: #60A5FA;
            --button-accent: #D97706;
        }

        .theme-male {
            --primary: #1E40AF;
            --secondary: #3B82F6;
            --accent: #059669;
            --light: #F0F9FF;
            --dark: #1E293B;
            --button-primary: #1E40AF;
            --button-secondary: #3B82F6;
            --button-accent: #059669;
        }

        .theme-female {
            --primary: #C026D3;
            --secondary: #E879F9;
            --accent: #DB2777;
            --light: #FDF4FF;
            --dark: #701A75;
            --button-primary: #C026D3;
            --button-secondary: #E879F9;
            --button-accent: #DB2777;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, var(--light) 0%, #ffffff 100%);
            color: var(--text);
            transition: all 0.4s ease;
            line-height: 1.6;
            min-height: 100vh;
            padding: var(--safe-top) 0 var(--safe-bottom) 0;
            touch-action: manipulation;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - var(--safe-top) - var(--safe-bottom));
            display: flex;
            flex-direction: column;
            position: relative;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1%, transparent 1%);
            background-size: 20px 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(180deg); }
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            z-index: 1;
            background: linear-gradient(135deg, #FFFFFF 0%, #FBBF24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.3rem;
            opacity: 0.95;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .active {
            display: flex;
        }

        .btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--button-primary) 0%, var(--button-secondary) 100%);
            color: white;
            border: none;
            padding: 18px 32px;
            margin: 10px 8px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.2);
            min-height: 60px;
            position: relative;
            overflow: hidden;
            min-width: 140px;
            touch-action: manipulation;
            user-select: none;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn:hover::after, .btn:active::after {
            opacity: 1;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--button-accent) 0%, var(--accent) 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--button-secondary) 0%, var(--secondary) 100%);
        }

        .btn-small {
            padding: 14px 24px;
            font-size: 1rem;
            min-height: 50px;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            min-width: 120px;
            font-size: 1rem;
            padding: 12px 20px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 18px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 1.05rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            border-left: 5px solid var(--primary);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mood-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .mood-item {
            background: white;
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            touch-action: manipulation;
            user-select: none;
        }

        .mood-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            border-color: var(--primary);
        }

        .mood-icon {
            font-size: 2.8rem;
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        .mood-item:hover .mood-icon {
            transform: scale(1.1);
        }

        .gift-message {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: white;
            border-radius: 20px;
            padding: 35px 30px;
            margin: 25px 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
            animation: pulse 2s infinite;
            border: 3px solid rgba(255,255,255,0.2);
        }

        @keyframes pulse {
            0% { box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3); }
            50% { box-shadow: 0 8px 30px rgba(37, 99, 235, 0.5); }
            100% { box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3); }
        }

        .gift-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .gift-text {
            font-size: 1.2rem;
            line-height: 1.7;
            margin-bottom: 20px;
        }

        .verse-card {
            background: white;
            border-radius: 16px;
            padding: 32px 28px;
            margin: 25px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
            animation: cardAppear 0.6s ease;
            border: 2px solid rgba(37, 99, 235, 0.1);
        }

        @keyframes cardAppear {
            0% { opacity: 0; transform: scale(0.9) rotate(-2deg); }
            100% { opacity: 1; transform: scale(1) rotate(0); }
        }

        .verse-text {
            font-size: 1.4rem;
            font-style: italic;
            margin-bottom: 20px;
            line-height: 1.8;
            color: var(--dark);
        }

        .verse-reference {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .favorite-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #E5E7EB;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            touch-action: manipulation;
        }

        .favorite-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        .favorite-btn.active {
            color: var(--accent);
            animation: heartBeat 0.6s ease;
        }

        @keyframes heartBeat {
            0% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1); }
            75% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #E5E7EB;
            overflow-x: auto;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex: 1;
            text-align: center;
            font-size: 1.1rem;
            touch-action: manipulation;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .journal-entry {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--secondary);
        }

        .journal-date {
            font-size: 0.95rem;
            color: #6B7280;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .journal-text {
            line-height: 1.6;
            font-size: 1.05rem;
        }

        .user-info {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            align-items: center;
            z-index: 10;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--button-accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-size: 1.2rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            padding: 12px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 120px;
            touch-action: manipulation;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .message {
            padding: 18px;
            border-radius: 12px;
            margin: 18px 0;
            text-align: center;
            animation: slideIn 0.4s ease;
            font-size: 1.05rem;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .message.success {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .message.error {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .import-section {
            margin-top: 35px;
            padding-top: 30px;
            border-top: 2px dashed #E5E7EB;
        }
        
        .file-input-wrapper {
            position: relative;
            margin: 18px 0;
        }
        
        .file-input {
            width: 100%;
            padding: 18px;
            border: 2px dashed var(--secondary);
            border-radius: 12px;
            background: rgba(96, 165, 250, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.05rem;
        }
        
        .file-input:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: var(--primary);
        }
        
        .file-input::file-selector-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 15px;
            font-weight: 600;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            color: #6B7280;
            font-size: 1rem;
        }

        .author {
            margin-top: 12px;
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .confetti {
            position: fixed;
            width: 12px;
            height: 12px;
            background-color: var(--accent);
            opacity: 0;
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(1000px) rotate(360deg); opacity: 0; }
        }

        .backup-reminder {
            background: linear-gradient(135deg, var(--warning) 0%, var(--accent) 100%);
            color: white;
            border-radius: 16px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .reminder-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .reminder-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        /* Mejoras para m√≥viles */
        @media (max-width: 768px) {
            .app-container {
                padding: 15px;
            }
            
            .mood-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .user-info {
                position: static;
                justify-content: center;
                margin-top: 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .btn {
                width: 100%;
                margin: 8px 0;
                min-height: 55px;
                font-size: 1rem;
            }
            
            .verse-text {
                font-size: 1.2rem;
            }
            
            .logout-btn {
                width: 100%;
                max-width: 200px;
            }
            
            header {
                padding: 25px 15px;
            }
            
            .user-avatar {
                margin-right: 0;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 480px) {
            .mood-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            header {
                padding: 20px 12px;
            }
            
            .btn {
                padding: 16px 24px;
                min-height: 50px;
            }
            
            .gift-message {
                padding: 25px 20px;
            }
            
            .verse-card {
                padding: 25px 20px;
            }
        }

        /* Correcciones espec√≠ficas para botones en m√≥viles */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover {
                transform: none;
            }
            
            .mood-item:hover {
                transform: none;
            }
            
            .btn:active, .mood-item:active {
                transform: scale(0.98);
            }
            
            .logout-btn:active {
                transform: scale(0.95);
            }
        }

        /* Mejora de accesibilidad para botones */
        .btn:focus-visible, .logout-btn:focus-visible, .favorite-btn:focus-visible {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Pantalla de Bienvenida -->
        <div id="welcome-screen" class="screen active">
            <header>
                <h1>Ilumina Tus Sentimientos</h1>
                <p class="subtitle">Encuentra paz y esperanza en cada emoci√≥n</p>
            </header>
            
            <div style="text-align: center; margin-top: 50px;">
                <i class="fas fa-heart" style="font-size: 5rem; color: var(--accent); margin-bottom: 35px; animation: bounce 2s infinite;"></i>
                <h2 style="margin-bottom: 25px; font-size: 2rem; color: var(--dark);">Bienvenido a Tu Refugio</h2>
                <p style="margin-bottom: 45px; font-size: 1.2rem; line-height: 1.7; color: var(--text);">
                    Descubre mensajes especiales de la Biblia que iluminar√°n tu d√≠a seg√∫n c√≥mo te sientes.
                </p>
                
                <div>
                    <button id="login-btn" class="btn">Iniciar Sesi√≥n</button>
                    <button id="register-btn" class="btn btn-accent">Registrarse</button>
                    <button id="load-data-btn" class="btn btn-secondary">
                        <i class="fas fa-upload"></i> Cargar Mis Datos
                    </button>
                </div>
            </div>
            
            <footer>
                <p>Basado en la Santa Biblia Reina-Valera 1960</p>
                <p class="author">Creado con ‚ù§Ô∏è por Jonathan Montenegro</p>
            </footer>
        </div>
        
        <!-- Pantalla de Registro -->
        <div id="register-screen" class="screen">
            <header>
                <h1>Crear Cuenta</h1>
                <p class="subtitle">Comienza tu viaje de luz interior</p>
            </header>
            
            <form id="register-form">
                <div class="form-group">
                    <label for="register-username">Nombre de Usuario</label>
                    <input type="text" id="register-username" required placeholder="Tu nombre √∫nico">
                </div>
                
                <div class="form-group">
                    <label for="register-password">Contrase√±a</label>
                    <input type="password" id="register-password" required placeholder="M√≠nimo 8 caracteres con 1 n√∫mero">
                    <div id="password-error" style="color: var(--danger); font-size: 0.9rem; margin-top: 8px; display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label for="register-gender">G√©nero (para personalizar tu experiencia)</label>
                    <select id="register-gender" required>
                        <option value="">Selecciona tu g√©nero</option>
                        <option value="male">Hombre</option>
                        <option value="female">Mujer</option>
                    </select>
                </div>
                
                <div style="text-align: center; margin-top: 35px;">
                    <button type="submit" class="btn btn-accent">Crear Mi Cuenta</button>
                    <button type="button" id="register-back" class="btn btn-back">Volver</button>
                </div>
            </form>
        </div>
        
        <!-- Pantalla de Login -->
        <div id="login-screen" class="screen">
            <header>
                <h1>Iniciar Sesi√≥n</h1>
                <p class="subtitle">Contin√∫a tu camino de luz</p>
            </header>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">Nombre de Usuario</label>
                    <input type="text" id="login-username" required placeholder="Tu nombre de usuario">
                </div>
                
                <div class="form-group">
                    <label for="login-password">Contrase√±a</label>
                    <input type="password" id="login-password" required placeholder="Tu contrase√±a">
                </div>
                
                <div style="text-align: center; margin-top: 35px;">
                    <button type="submit" class="btn btn-accent">Ingresar</button>
                    <button type="button" id="login-back" class="btn btn-back">Volver</button>
                </div>
            </form>
        </div>
        
        <!-- Pantalla Principal -->
        <div id="main-screen" class="screen">
            <header>
                <h1>Ilumina Tus Sentimientos</h1>
                <p class="subtitle">Selecciona c√≥mo te sientes hoy</p>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <button id="logout-btn" class="logout-btn">Cerrar Sesi√≥n</button>
                </div>
            </header>
            
            <div class="mood-grid" id="mood-grid">
                <!-- Los estados de √°nimo se cargar√°n din√°micamente -->
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 25px;">
                <button id="favorites-btn" class="btn btn-secondary">
                    <i class="fas fa-gem"></i> Mis Tesoros Guardados
                </button>
                <button id="journal-btn" class="btn btn-secondary">
                    <i class="fas fa-book-open"></i> Mi Diario Personal
                </button>
                <button id="data-btn" class="btn">
                    <i class="fas fa-database"></i> Respaldar Mis Datos
                </button>
            </div>
        </div>
        
        <!-- Pantalla de Mensaje Regalo -->
        <div id="gift-screen" class="screen">
            <header>
                <h1>Tu Regalo Especial</h1>
                <p class="subtitle">Un mensaje personal para tu coraz√≥n</p>
                <div class="user-info">
                    <div class="user-avatar" id="gift-user-avatar">U</div>
                    <button id="gift-back" class="logout-btn">Volver</button>
                </div>
            </header>
            
            <div id="gift-container">
                <!-- El mensaje regalo se cargar√° din√°micamente -->
            </div>
            
            <div style="text-align: center; margin-top: 35px;">
                <button id="open-gift-btn" class="btn btn-accent">
                    <i class="fas fa-gift"></i> Abrir Mi Vers√≠culo Especial
                </button>
            </div>
        </div>
        
        <!-- Pantalla de Vers√≠culos -->
        <div id="verse-screen" class="screen">
            <header>
                <h1>Tu Regalo del D√≠a</h1>
                <p class="subtitle">Palabra de Dios para tu coraz√≥n</p>
                <div class="user-info">
                    <div class="user-avatar" id="verse-user-avatar">U</div>
                    <button id="verse-back" class="logout-btn">Volver</button>
                </div>
            </header>
            
            <div id="verse-container">
                <!-- El vers√≠culo se cargar√° din√°micamente -->
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button id="new-verse-btn" class="btn btn-accent">Otro Vers√≠culo</button>
                <button id="add-favorite-btn" class="btn">
                    <i class="far fa-heart"></i> Guardar en Tesoros
                </button>
            </div>
        </div>
        
        <!-- Pantalla de Favoritos y Diario -->
        <div id="favorites-screen" class="screen">
            <header>
                <h1>Mis Tesoros</h1>
                <p class="subtitle">Tus vers√≠culos guardados y reflexiones</p>
                <div class="user-info">
                    <div class="user-avatar" id="fav-user-avatar">U</div>
                    <button id="fav-back" class="logout-btn">Volver</button>
                </div>
            </header>
            
            <div class="tabs">
                <div class="tab active" data-tab="favorites">Tesoros</div>
                <div class="tab" data-tab="journal">Mi Diario</div>
            </div>
            
            <div class="tab-content active" id="favorites-tab">
                <div id="favorites-list">
                    <!-- Los favoritos se cargar√°n din√°micamente -->
                </div>
            </div>
            
            <div class="tab-content" id="journal-tab">
                <div class="form-group">
                    <label for="journal-entry">Escribe tu reflexi√≥n:</label>
                    <textarea id="journal-entry" rows="5" placeholder="Comparte tus pensamientos, oraciones o lo que Dios est√° haciendo en tu vida..."></textarea>
                </div>
                <button id="save-journal-btn" class="btn btn-accent">Guardar en Mi Diario</button>
                
                <div id="journal-entries" style="margin-top: 35px;">
                    <!-- Las entradas del diario se cargar√°n din√°micamente -->
                </div>
            </div>
        </div>
        
        <!-- Pantalla de Exportar/Importar -->
        <div id="data-screen" class="screen">
            <header>
                <h1>Respaldar Mis Datos</h1>
                <p class="subtitle">Mant√©n seguros tus tesoros espirituales</p>
                <div class="user-info">
                    <div class="user-avatar" id="data-user-avatar">U</div>
                    <button id="data-back" class="logout-btn">Volver</button>
                </div>
            </header>
            
            <div class="card">
                <h3><i class="fas fa-download"></i> Exportar Mis Datos</h3>
                <p>Guarda tus vers√≠culos favoritos y entradas de diario.</p>
                
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button id="save-data-btn" class="btn btn-accent">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    <button id="export-data-btn" class="btn btn-secondary">
                        <i class="fas fa-file-export"></i> Guardar Como
                    </button>
                </div>
                
                <div id="last-save-info" style="margin-top: 15px; padding: 12px; background: rgba(96, 165, 250, 0.1); border-radius: 8px; display: none;">
                    <small><i class="fas fa-info-circle"></i> <span id="last-save-text"></span></small>
                </div>
            </div>
            
            <div class="card import-section">
                <h3><i class="fas fa-upload"></i> Importar Datos</h3>
                <p>Restaura tus datos desde un archivo previamente exportado.</p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="import-file" class="file-input" accept=".json">
                </div>
                
                <button id="import-data-btn" class="btn btn-secondary">
                    <i class="fas fa-file-import"></i> Importar Datos
                </button>
            </div>
            
            <div id="data-message" class="message" style="display: none;"></div>
        </div>

        <!-- Pantalla de Cargar Datos -->
        <div id="load-data-screen" class="screen">
            <header>
                <h1>Cargar Mis Datos</h1>
                <p class="subtitle">Recupera tus tesoros espirituales</p>
            </header>
            
            <div class="card">
                <h3><i class="fas fa-upload"></i> Importar desde Archivo</h3>
                <p>Selecciona tu archivo JSON para recuperar tus datos.</p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="load-data-file" class="file-input" accept=".json">
                </div>
                
                <button id="process-data-btn" class="btn btn-accent">
                    <i class="fas fa-cloud-upload-alt"></i> Procesar Archivo
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="load-data-back" class="btn btn-back">Volver al Inicio</button>
            </div>
            
            <div id="load-data-message" class="message" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Datos de vers√≠culos b√≠blicos por estado de √°nimo
        const bibleVerses = {
            tristeza: [
                { text: "El llanto puede durar toda la noche, pero a la ma√±ana vendr√° la alegr√≠a.", reference: "Salmos 30:5" },
                { text: "Bendito sea el Dios y Padre de nuestro Se√±or Jesucristo, Padre de misericordias y Dios de toda consolaci√≥n.", reference: "2 Corintios 1:3" },
                { text: "Jehov√° est√° cerca de los quebrantados de coraz√≥n; y salva a los contritos de esp√≠ritu.", reference: "Salmos 34:18" },
                { text: "No os entristezc√°is, porque el gozo de Jehov√° es vuestra fuerza.", reference: "Nehem√≠as 8:10" },
                { text: "Porque su ira dura solo un momento; pero su favor dura toda la vida.", reference: "Salmos 30:5" }
            ],
            ansiedad: [
                { text: "Por nada est√©is afanosos, sino sean conocidas vuestras peticiones delante de Dios en toda oraci√≥n y ruego, con acci√≥n de gracias.", reference: "Filipenses 4:6" },
                { text: "Echando toda vuestra ansiedad sobre √©l, porque √©l tiene cuidado de vosotros.", reference: "1 Pedro 5:7" },
                { text: "La paz de Dios, que sobrepasa todo entendimiento, guardar√° vuestros corazones y vuestros pensamientos en Cristo Jes√∫s.", reference: "Filipenses 4:7" },
                { text: "No se turbe vuestro coraz√≥n; cre√©is en Dios, creed tambi√©n en m√≠.", reference: "Juan 14:1" }
            ],
            desesperanza: [
                { text: "Porque yo s√© los pensamientos que tengo acerca de vosotros, dice Jehov√°, pensamientos de paz, y no de mal, para daros el fin que esper√°is.", reference: "Jerem√≠as 29:11" },
                { text: "Pero los que esperan a Jehov√° tendr√°n nuevas fuerzas; levantar√°n alas como las √°guilas; correr√°n, y no se cansar√°n; caminar√°n, y no se fatigar√°n.", reference: "Isa√≠as 40:31" },
                { text: "Y el Dios de esperanza os llene de todo gozo y paz en el creer, para que abund√©is en esperanza por el poder del Esp√≠ritu Santo.", reference: "Romanos 15:13" }
            ],
            felicidad: [
                { text: "Gozaos en el Se√±or siempre. Otra vez digo: ¬°Gozaos!", reference: "Filipenses 4:4" },
                { text: "Estas cosas os he hablado para que mi gozo est√© en vosotros, y vuestro gozo sea cumplido.", reference: "Juan 15:11" },
                { text: "Me mostrar√°s la senda de la vida; en tu presencia hay plenitud de gozo; delicias a tu diestra para siempre.", reference: "Salmos 16:11" }
            ],
            paz: [
                { text: "La paz de Dios, que sobrepasa todo entendimiento, guardar√° vuestros corazones y vuestros pensamientos en Cristo Jes√∫s.", reference: "Filipenses 4:7" },
                { text: "Estas cosas os he hablado para que en m√≠ teng√°is paz. En el mundo tendr√©is aflicci√≥n; pero confiad, yo he vencido al mundo.", reference: "Juan 16:33" },
                { text: "T√∫ guardar√°s en completa paz a aquel cuyo pensamiento en ti persevera; porque en ti ha confiado.", reference: "Isa√≠as 26:3" }
            ],
            esperanza: [
                { text: "Porque yo s√© los pensamientos que tengo acerca de vosotros, dice Jehov√°, pensamientos de paz, y no de mal, para daros el fin que esper√°is.", reference: "Jerem√≠as 29:11" },
                { text: "Y el Dios de esperanza os llene de todo gozo y paz en el creer, para que abund√©is en esperanza por el poder del Esp√≠ritu Santo.", reference: "Romanos 15:13" },
                { text: "Es, pues, la fe la certeza de lo que se espera, la convicci√≥n de lo que no se ve.", reference: "Hebreos 11:1" }
            ],
            fortaleza: [
                { text: "Todo lo puedo en Cristo que me fortalece.", reference: "Filipenses 4:13" },
                { text: "El da esfuerzo al cansado, y multiplica las fuerzas al que no tiene ningunas.", reference: "Isa√≠as 40:29" },
                { text: "Jehov√° es mi fortaleza y mi escudo; en √©l confi√≥ mi coraz√≥n, y fui ayudado.", reference: "Salmos 28:7" }
            ],
            miedo: [
                { text: "No temas, porque yo estoy contigo; no desmayes, porque yo soy tu Dios que te esfuerzo.", reference: "Isa√≠as 41:10" },
                { text: "Porque no nos ha dado Dios esp√≠ritu de cobard√≠a, sino de poder, de amor y de dominio propio.", reference: "2 Timoteo 1:7" },
                { text: "Jehov√° es mi luz y mi salvaci√≥n; ¬øde qui√©n temer√©?", reference: "Salmos 27:1" }
            ],
            gratitud: [
                { text: "Dad gracias en todo, porque esta es la voluntad de Dios para con vosotros en Cristo Jes√∫s.", reference: "1 Tesalonicenses 5:18" },
                { text: "Entrad por sus puertas con acci√≥n de gracias, por sus atrios con alabanza.", reference: "Salmos 100:4" },
                { text: "Bendice, alma m√≠a, a Jehov√°, y no olvides ninguno de sus beneficios.", reference: "Salmos 103:2" }
            ],
            fe: [
                { text: "Es, pues, la fe la certeza de lo que se espera, la convicci√≥n de lo que no se ve.", reference: "Hebreos 11:1" },
                { text: "Jes√∫s le dijo: Si puedes creer, al que cree todo le es posible.", reference: "Marcos 9:23" },
                { text: "Porque por fe andamos, no por vista.", reference: "2 Corintios 5:7" }
            ]
        };

        // Estados de √°nimo con mensajes regalo personalizados
        const moods = [
            { 
                id: 'tristeza', 
                name: 'Tristeza', 
                icon: 'fas fa-tint',
                giftTitle: 'üíå ¬°MENSAJE ESPECIAL PARA TU ALMA!',
                giftMessage: {
                    female: 'Se√±orita [nombre], las l√°grimas no son permanentes... Hoy Dios quiere secarlas con este vers√≠culo especialmente para ti.',
                    male: 'Mi L√≠der [nombre], en los momentos dif√≠ciles... Dios fortalece tu esp√≠ritu con esta palabra de consuelo personalizada.'
                }
            },
            { 
                id: 'ansiedad', 
                name: 'Ansiedad', 
                icon: 'fas fa-wind',
                giftTitle: 'üì¶ ¬°PAQUETE DE PAZ PARA TI!',
                giftMessage: {
                    female: 'Se√±orita [nombre], la ansiedad puede ser abrumadora... Dios te tiene un mensaje especial de tranquilidad personalizado.',
                    male: 'Mi L√≠der [nombre], cuando la preocupaci√≥n acecha... Dios te env√≠a esta armadura de paz dise√±ada para ti.'
                }
            },
            { 
                id: 'desesperanza', 
                name: 'Desesperanza', 
                icon: 'fas fa-cloud',
                giftTitle: 'üåü ¬°REGALO DE ESPERANZA ENTREGADO!',
                giftMessage: {
                    female: 'Querida Se√±orita [nombre], en la oscuridad... Dios enciende una luz especial con esta palabra para tu coraz√≥n.',
                    male: 'Valiente L√≠der [nombre], cuando el camino se oscurece... Dios ilumina tu senda con este mensaje de esperanza.'
                }
            },
            { 
                id: 'felicidad', 
                name: 'Felicidad', 
                icon: 'fas fa-smile',
                giftTitle: 'üéâ ¬°CELEBREMOS JUNTOS TU ALEGR√çA!',
                giftMessage: {
                    female: 'Se√±orita [nombre], tu felicidad es un regalo... Dios quiere aumentarla con esta bendici√≥n especial para ti.',
                    male: 'Mi L√≠der [nombre], tu gozo inspira... Dios celebra contigo y te bendice con esta palabra de alegr√≠a.'
                }
            },
            { 
                id: 'paz', 
                name: 'Paz', 
                icon: 'fas fa-dove',
                giftTitle: 'üïäÔ∏è ¬°KIT DE TRANQUILIDAD PERSONALIZADO!',
                giftMessage: {
                    female: 'Se√±orita [nombre], en un mundo ruidoso... Dios te ofrece este oasis de paz dise√±ado especialmente para ti.',
                    male: 'Mi L√≠der [nombre], en medio del caos... Dios te regala este puerto de tranquilidad hecho a tu medida.'
                }
            },
            { 
                id: 'esperanza', 
                name: 'Esperanza', 
                icon: 'fas fa-seedling',
                giftTitle: '‚ú® ¬°FUTURO BRILLANTE ASEGURADO!',
                giftMessage: {
                    female: 'Se√±orita [nombre], tus mejores d√≠as est√°n por venir... Dios te garantiza este futuro brillante con su palabra.',
                    male: 'Mi L√≠der [nombre], el ma√±ana te pertenece... Dios confirma tu destino glorioso con este mensaje de esperanza.'
                }
            },
            { 
                id: 'fortaleza', 
                name: 'Fortaleza', 
                icon: 'fas fa-fist-raised',
                giftTitle: 'üí™ ¬°EQUIPO DE FUERZA DIVINA!',
                giftMessage: {
                    female: 'Se√±orita [nombre], para tus desaf√≠os de hoy... Dios te equipa con esta palabra de poder personalizada.',
                    male: 'Mi L√≠der [nombre], para las batallas que enfrentas... Dios te arma con esta fuerza divina especial.'
                }
            },
            { 
                id: 'miedo', 
                name: 'Miedo', 
                icon: 'fas fa-ghost',
                giftTitle: 'üõ°Ô∏è ¬°ESCUDO DE PROTECCI√ìN ENTREGADO!',
                giftMessage: {
                    female: 'Se√±orita [nombre], el miedo no tiene poder... Dios te env√≠a este mensaje de seguridad hecho para ti.',
                    male: 'Mi L√≠der [nombre], el temor se disipa... Dios te cubre con este escudo de protecci√≥n divina.'
                }
            },
            { 
                id: 'gratitud', 
                name: 'Gratitud', 
                icon: 'fas fa-hands',
                giftTitle: 'üôè ¬°BENDICI√ìN MULTIPLICADA!',
                giftMessage: {
                    female: 'Se√±orita [nombre], tu coraz√≥n agradecido... Abre ventanas del cielo con esta palabra especial de gratitud.',
                    male: 'Mi L√≠der [nombre], tu actitud de gratitud... Multiplica bendiciones con este mensaje de agradecimiento.'
                }
            },
            { 
                id: 'fe', 
                name: 'Fe', 
                icon: 'fas fa-mountain',
                giftTitle: '‚ö° ¬°INYECCI√ìN DE FE PREMIUM!',
                giftMessage: {
                    female: 'Se√±orita [nombre], la fe mueve monta√±as... Hoy Dios fortalece la tuya con este mensaje poderoso personalizado.',
                    male: 'Mi L√≠der [nombre], tu fe es inquebrantable... Dios la potencia con esta inyecci√≥n divina de confianza.'
                }
            }
        ];

        // Variables globales
        let currentUser = null;
        let currentMood = null;
        let currentVerse = null;
        let lastSavePath = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            checkLoggedInUser();
            setupEventListeners();
            loadMoods();
        });

        // Verificar usuario logueado
        function checkLoggedInUser() {
            const loggedInUser = localStorage.getItem('currentUser');
            if (loggedInUser) {
                currentUser = JSON.parse(loggedInUser);
                applyUserTheme();
                showScreen('main-screen');
                updateUserAvatar();
                showWelcomeMessage();
            }
        }

        // Mostrar mensaje de bienvenida personalizado
        function showWelcomeMessage() {
            if (!currentUser) return;
            
            const welcomeMessages = {
                female: `¬°Se√±orita ${currentUser.username}! üí´ Tu luz interior brilla hoy`,
                male: `¬°Mi L√≠der ${currentUser.username}! üí™ Tu fortaleza inspira hoy`
            };
            
            const message = welcomeMessages[currentUser.gender] || `¬°Hola ${currentUser.username}! ‚ú®`;
            createConfetti(15);
        }

        // Aplicar tema seg√∫n g√©nero
        function applyUserTheme() {
            if (currentUser && currentUser.gender) {
                document.body.classList.remove('theme-male', 'theme-female');
                document.body.classList.add(`theme-${currentUser.gender}`);
            }
        }

        // Actualizar avatar
        function updateUserAvatar() {
            const avatars = document.querySelectorAll('.user-avatar');
            avatars.forEach(avatar => {
                if (currentUser) {
                    avatar.textContent = currentUser.username.charAt(0).toUpperCase();
                }
            });
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Navegaci√≥n
            document.getElementById('login-btn').addEventListener('click', () => showScreen('login-screen'));
            document.getElementById('register-btn').addEventListener('click', () => showScreen('register-screen'));
            document.getElementById('load-data-btn').addEventListener('click', () => showScreen('load-data-screen'));
            document.getElementById('register-back').addEventListener('click', () => showScreen('welcome-screen'));
            document.getElementById('login-back').addEventListener('click', () => showScreen('welcome-screen'));
            document.getElementById('load-data-back').addEventListener('click', () => showScreen('welcome-screen'));
            document.getElementById('logout-btn').addEventListener('click', logoutWithReminder);
            document.getElementById('verse-back').addEventListener('click', () => showScreen('main-screen'));
            document.getElementById('fav-back').addEventListener('click', () => showScreen('main-screen'));
            document.getElementById('data-back').addEventListener('click', () => showScreen('main-screen'));
            document.getElementById('gift-back').addEventListener('click', () => showScreen('main-screen'));
            document.getElementById('data-btn').addEventListener('click', () => showScreen('data-screen'));
            
            // Formularios
            document.getElementById('register-form').addEventListener('submit', registerUser);
            document.getElementById('login-form').addEventListener('submit', loginUser);
            document.getElementById('register-password').addEventListener('input', validatePassword);
            
            // Botones principales
            document.getElementById('favorites-btn').addEventListener('click', () => {
                loadFavorites();
                loadJournalEntries();
                showScreen('favorites-screen');
            });
            document.getElementById('journal-btn').addEventListener('click', () => {
                document.querySelector('[data-tab="journal"]').click();
                showScreen('favorites-screen');
            });
            
            // Funcionalidad vers√≠culos
            document.getElementById('new-verse-btn').addEventListener('click', showRandomVerse);
            document.getElementById('add-favorite-btn').addEventListener('click', addToFavorites);
            document.getElementById('open-gift-btn').addEventListener('click', showRandomVerseScreen);
            
            // Pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Cargar contenido espec√≠fico de la pesta√±a
                    if (tabId === 'favorites') {
                        loadFavorites();
                    } else if (tabId === 'journal') {
                        loadJournalEntries();
                    }
                });
            });
            
            // Diario
            document.getElementById('save-journal-btn').addEventListener('click', saveJournalEntry);
            
            // Exportar/Importar
            document.getElementById('save-data-btn').addEventListener('click', saveUserDataToFile);
            document.getElementById('export-data-btn').addEventListener('click', exportUserData);
            document.getElementById('import-data-btn').addEventListener('click', importUserData);
            document.getElementById('process-data-btn').addEventListener('click', processLoadedData);
        }

        // Cargar estados de √°nimo
        function loadMoods() {
            const moodGrid = document.getElementById('mood-grid');
            moodGrid.innerHTML = '';
            
            moods.forEach(mood => {
                const moodElement = document.createElement('div');
                moodElement.className = 'mood-item';
                moodElement.innerHTML = `
                    <div class="mood-icon">
                        <i class="${mood.icon}"></i>
                    </div>
                    <div class="mood-name">${mood.name}</div>
                `;
                moodElement.addEventListener('click', () => selectMood(mood));
                moodGrid.appendChild(moodElement);
            });
        }

        // Seleccionar estado de √°nimo
        function selectMood(mood) {
            if (!currentUser) {
                showMessage('Por favor, inicia sesi√≥n primero', 'error');
                showScreen('login-screen');
                return;
            }
            currentMood = mood;
            showGiftMessage();
            showScreen('gift-screen');
        }

        // Mostrar mensaje regalo
        function showGiftMessage() {
            if (!currentMood || !currentUser) return;
            
            const userMessage = currentMood.giftMessage[currentUser.gender] || currentMood.giftMessage.male;
            const personalizedMessage = userMessage.replace('[nombre]', currentUser.username);
            
            const giftContainer = document.getElementById('gift-container');
            giftContainer.innerHTML = `
                <div class="gift-message">
                    <div class="gift-title">${currentMood.giftTitle}</div>
                    <div class="gift-text">${personalizedMessage}</div>
                </div>
            `;
            
            createConfetti(8);
        }

        // Mostrar pantalla de vers√≠culos
        function showRandomVerseScreen() {
            if (!currentMood) return;
            showRandomVerse();
            showScreen('verse-screen');
        }

        // Mostrar vers√≠culo aleatorio
        function showRandomVerse() {
            if (!currentMood) return;
            
            const verses = bibleVerses[currentMood.id];
            if (!verses || verses.length === 0) return;
            
            const randomIndex = Math.floor(Math.random() * verses.length);
            currentVerse = verses[randomIndex];
            
            const verseContainer = document.getElementById('verse-container');
            verseContainer.innerHTML = `
                <div class="verse-card">
                    <button class="favorite-btn" id="verse-favorite-btn">
                        <i class="far fa-heart"></i>
                    </button>
                    <div class="verse-text">"${currentVerse.text}"</div>
                    <div class="verse-reference">${currentVerse.reference}</div>
                </div>
            `;
            
            const userData = getUserData();
            const isFavorite = userData.favorites.some(fav => 
                fav.text === currentVerse.text && fav.reference === currentVerse.reference
            );
            
            const favoriteBtn = document.getElementById('verse-favorite-btn');
            if (isFavorite) {
                favoriteBtn.innerHTML = '<i class="fas fa-heart"></i>';
                favoriteBtn.classList.add('active');
            }
            
            favoriteBtn.addEventListener('click', toggleFavorite);
            createConfetti(5);
        }

        // Alternar favorito
        function toggleFavorite() {
            if (!currentVerse) return;
            
            const userData = getUserData();
            const favoriteIndex = userData.favorites.findIndex(fav => 
                fav.text === currentVerse.text && fav.reference === currentVerse.reference
            );
            
            const favoriteBtn = document.getElementById('verse-favorite-btn');
            
            if (favoriteIndex === -1) {
                userData.favorites.push({
                    text: currentVerse.text,
                    reference: currentVerse.reference,
                    mood: currentMood.id,
                    date: new Date().toISOString()
                });
                favoriteBtn.innerHTML = '<i class="fas fa-heart"></i>';
                favoriteBtn.classList.add('active');
                showMessage('‚ú® ¬°Vers√≠culo guardado en tus tesoros!', 'success');
                createConfetti(8);
            } else {
                userData.favorites.splice(favoriteIndex, 1);
                favoriteBtn.innerHTML = '<i class="far fa-heart"></i>';
                favoriteBtn.classList.remove('active');
                showMessage('Vers√≠culo eliminado de favoritos', 'success');
            }
            
            saveUserData(userData);
        }

        // A√±adir a favoritos
        function addToFavorites() {
            toggleFavorite();
        }

        // Cargar favoritos
        function loadFavorites() {
            const userData = getUserData();
            const favoritesList = document.getElementById('favorites-list');
            
            if (userData.favorites.length === 0) {
                favoritesList.innerHTML = '<p style="text-align: center; padding: 40px; color: #6B7280;">A√∫n no tienes vers√≠culos guardados en tus tesoros.</p>';
                return;
            }
            
            favoritesList.innerHTML = '';
            userData.favorites.forEach((fav, index) => {
                const favoriteElement = document.createElement('div');
                favoriteElement.className = 'verse-card';
                favoriteElement.innerHTML = `
                    <button class="favorite-btn active" data-index="${index}">
                        <i class="fas fa-heart"></i>
                    </button>
                    <div class="verse-text">"${fav.text}"</div>
                    <div class="verse-reference">${fav.reference}</div>
                    <div style="margin-top: 12px; font-size: 0.9rem; color: #6B7280;">
                        Guardado el ${new Date(fav.date).toLocaleDateString()}
                    </div>
                `;
                
                const removeBtn = favoriteElement.querySelector('.favorite-btn');
                removeBtn.addEventListener('click', function() {
                    removeFavorite(parseInt(this.getAttribute('data-index')));
                });
                
                favoritesList.appendChild(favoriteElement);
            });
        }

        // Eliminar favorito
        function removeFavorite(index) {
            const userData = getUserData();
            userData.favorites.splice(index, 1);
            saveUserData(userData);
            loadFavorites();
            showMessage('Vers√≠culo eliminado de tus tesoros', 'success');
        }

        // Cargar entradas diario
        function loadJournalEntries() {
            const userData = getUserData();
            const journalEntries = document.getElementById('journal-entries');
            
            if (userData.journal.length === 0) {
                journalEntries.innerHTML = '<p style="text-align: center; padding: 40px; color: #6B7280;">A√∫n no tienes entradas en tu diario personal.</p>';
                return;
            }
            
            journalEntries.innerHTML = '';
            userData.journal.forEach((entry, index) => {
                const entryElement = document.createElement('div');
                entryElement.className = 'journal-entry';
                entryElement.innerHTML = `
                    <div class="journal-date">${new Date(entry.date).toLocaleString()}</div>
                    <div class="journal-text">${entry.text}</div>
                    <button class="btn btn-small" data-index="${index}" style="margin-top: 12px; background: rgba(239,68,68,0.1); color: var(--danger);">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                `;
                
                const deleteBtn = entryElement.querySelector('button');
                deleteBtn.addEventListener('click', function() {
                    deleteJournalEntry(parseInt(this.getAttribute('data-index')));
                });
                
                journalEntries.appendChild(entryElement);
            });
        }

        // Guardar entrada diario
        function saveJournalEntry() {
            const journalText = document.getElementById('journal-entry').value.trim();
            
            if (!journalText) {
                showMessage('Por favor, escribe algo en tu diario', 'error');
                return;
            }
            
            const userData = getUserData();
            userData.journal.unshift({
                text: journalText,
                date: new Date().toISOString()
            });
            
            saveUserData(userData);
            document.getElementById('journal-entry').value = '';
            loadJournalEntries();
            showMessage('‚ú® ¬°Entrada guardada en tu diario personal!', 'success');
            createConfetti(5);
        }

        // Eliminar entrada diario
        function deleteJournalEntry(index) {
            const userData = getUserData();
            userData.journal.splice(index, 1);
            saveUserData(userData);
            loadJournalEntries();
            showMessage('Entrada eliminada del diario', 'success');
        }

        // Validar contrase√±a
        function validatePassword() {
            const password = document.getElementById('register-password').value;
            const errorElement = document.getElementById('password-error');
            
            if (password.length < 8) {
                errorElement.textContent = 'La contrase√±a debe tener al menos 8 caracteres';
                errorElement.style.display = 'block';
                return false;
            }
            
            if (!/\d/.test(password)) {
                errorElement.textContent = 'La contrase√±a debe contener al menos 1 n√∫mero';
                errorElement.style.display = 'block';
                return false;
            }
            
            errorElement.style.display = 'none';
            return true;
        }

        // Registrar usuario
        function registerUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            const gender = document.getElementById('register-gender').value;
            
            if (!username || !password || !gender) {
                showMessage('Por favor, completa todos los campos', 'error');
                return;
            }
            
            if (!validatePassword()) {
                return;
            }
            
            const existingUsers = JSON.parse(localStorage.getItem('users') || '{}');
            if (existingUsers[username]) {
                showMessage('Este nombre de usuario ya est√° en uso', 'error');
                return;
            }
            
            existingUsers[username] = {
                username,
                password,
                gender,
                favorites: [],
                journal: [],
                lastBackup: null
            };
            
            localStorage.setItem('users', JSON.stringify(existingUsers));
            
            currentUser = { username, gender };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            applyUserTheme();
            updateUserAvatar();
            showScreen('main-screen');
            showWelcomeMessage();
            
            showMessage('‚ú® ¬°Cuenta creada exitosamente!', 'success');
            createConfetti(15);
        }

        // Iniciar sesi√≥n
        function loginUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                showMessage('Por favor, completa todos los campos', 'error');
                return;
            }
            
            const existingUsers = JSON.parse(localStorage.getItem('users') || '{}');
            const user = existingUsers[username];
            
            if (!user || user.password !== password) {
                showMessage('Usuario o contrase√±a incorrectos', 'error');
                return;
            }
            
            currentUser = { username, gender: user.gender };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            applyUserTheme();
            updateUserAvatar();
            showScreen('main-screen');
            showWelcomeMessage();
            
            showMessage(`‚ú® ¬°Bienvenido de nuevo, ${username}!`, 'success');
            createConfetti(10);
        }

        // Cerrar sesi√≥n con recordatorio
        function logoutWithReminder() {
            const userData = getUserData();
            const lastBackup = userData.lastBackup;
            const today = new Date().toISOString().split('T')[0];
            
            if (!lastBackup || lastBackup !== today) {
                if (confirm('¬øQuieres GUARDAR tus datos antes de salir?\n\n- "Aceptar": Actualiza tu archivo existente\n- "Cancelar": No guardar cambios\n\nTus tesoros y reflexiones estar√°n m√°s seguros.')) {
                    saveUserDataToFile();
                }
            }
            
            currentUser = null;
            localStorage.removeItem('currentUser');
            showScreen('welcome-screen');
            showMessage('¬°Hasta pronto! Vuelve por tu pr√≥ximo regalo divino üåà', 'success');
        }

        // Guardar datos (actualizar archivo existente)
        function saveUserDataToFile() {
            const userData = getUserData();
            const exportData = {
                app: "Ilumina Tus Sentimientos",
                version: "1.0",
                exportDate: new Date().toISOString(),
                user: currentUser.username,
                gender: currentUser.gender,
                ...userData
            };
            
            // Actualizar √∫ltimo respaldo
            userData.lastBackup = new Date().toISOString().split('T')[0];
            saveUserData(userData);
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Si tenemos una ruta guardada anteriormente, intentar usar el mismo archivo
            if (lastSavePath) {
                try {
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = lastSavePath;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showMessage('‚ú® ¬°Datos guardados exitosamente!', 'success');
                    updateLastSaveInfo();
                    createConfetti(5);
                    return;
                } catch (error) {
                    console.log('No se pudo guardar en la ubicaci√≥n anterior, se usar√° "Guardar Como"');
                }
            }
            
            // Si no hay ruta guardada o fall√≥, usar "Guardar Como"
            exportDataAsNewFile(exportData, dataBlob);
        }

        // Guardar como nuevo archivo
        function exportDataAsNewFile(exportData, dataBlob) {
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `ilumina_tus_sentimientos_${currentUser.username}_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Guardar la ruta para futuros "Guardar"
            lastSavePath = a.download;
            
            showMessage('‚ú® ¬°Datos guardados como nuevo archivo!', 'success');
            updateLastSaveInfo();
            createConfetti(8);
        }

        // Exportar datos (funci√≥n original - ahora es "Guardar Como")
        function exportUserData() {
            const userData = getUserData();
            const exportData = {
                app: "Ilumina Tus Sentimientos",
                version: "1.0",
                exportDate: new Date().toISOString(),
                user: currentUser.username,
                gender: currentUser.gender,
                ...userData
            };
            
            // Actualizar √∫ltimo respaldo
            userData.lastBackup = new Date().toISOString().split('T')[0];
            saveUserData(userData);
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            exportDataAsNewFile(exportData, dataBlob);
        }

        // Actualizar informaci√≥n del √∫ltimo guardado
        function updateLastSaveInfo() {
            const lastSaveInfo = document.getElementById('last-save-info');
            const lastSaveText = document.getElementById('last-save-text');
            
            if (lastSavePath) {
                const fileName = lastSavePath.split('/').pop() || lastSavePath;
                lastSaveText.textContent = `√öltimo guardado: ${fileName}`;
                lastSaveInfo.style.display = 'block';
            } else {
                lastSaveInfo.style.display = 'none';
            }
        }

        // Recordar la ruta al importar
        function rememberImportedFilePath(file) {
            lastSavePath = file.name;
            updateLastSaveInfo();
        }

        // Importar datos
        function importUserData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Por favor, selecciona un archivo JSON primero', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.favorites || !importedData.journal) {
                        throw new Error('Este no es un archivo v√°lido de "Ilumina Tus Sentimientos"');
                    }
                    
                    // Para usuarios logueados, ofrecer opciones de importaci√≥n
                    if (currentUser) {
                        const choice = confirm(`¬øQuieres fusionar los datos del archivo con tu cuenta actual (${currentUser.username})?\n\n- Aceptar: Se fusionar√°n los datos\n- Cancelar: Se reemplazar√°n todos los datos`);
                        
                        const userData = getUserData();
                        const existingUsers = JSON.parse(localStorage.getItem('users') || '{}');
                        
                        if (choice) {
                            // FUSI√ìN: A√±adir solo datos nuevos
                            importedData.favorites.forEach(newFav => {
                                const exists = userData.favorites.some(existingFav => 
                                    existingFav.text === newFav.text && existingFav.reference === newFav.reference
                                );
                                if (!exists) {
                                    userData.favorites.push(newFav);
                                }
                            });
                            
                            importedData.journal.forEach(newEntry => {
                                const exists = userData.journal.some(existingEntry => 
                                    existingEntry.text === newEntry.text && existingEntry.date === newEntry.date
                                );
                                if (!exists) {
                                    userData.journal.push(newEntry);
                                }
                            });
                            
                            showMessage('‚ú® ¬°Datos fusionados exitosamente!', 'success');
                        } else {
                            // REEMPLAZO: Usar los datos del archivo
                            userData.favorites = importedData.favorites;
                            userData.journal = importedData.journal;
                            showMessage('‚ú® ¬°Datos reemplazados exitosamente!', 'success');
                        }
                        
                        // Actualizar √∫ltimo respaldo
                        userData.lastBackup = new Date().toISOString().split('T')[0];
                        
                        // Guardar cambios
                        existingUsers[currentUser.username] = {
                            ...existingUsers[currentUser.username],
                            ...userData
                        };
                        
                        localStorage.setItem('users', JSON.stringify(existingUsers));
                        
                        // Recargar vistas si es necesario
                        if (document.getElementById('favorites-screen').classList.contains('active')) {
                            loadFavorites();
                            loadJournalEntries();
                        }
                    }
                    
                    fileInput.value = '';
                    rememberImportedFilePath(file);
                    createConfetti(8);
                    
                } catch (error) {
                    showMessage('Error al importar: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Procesar datos cargados
        function processLoadedData() {
            const fileInput = document.getElementById('load-data-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showLoadDataMessage('Por favor, selecciona un archivo JSON', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.favorites || !importedData.journal || !importedData.user) {
                        throw new Error('Archivo no v√°lido de "Ilumina Tus Sentimientos"');
                    }
                    
                    // Obtener usuarios existentes
                    const existingUsers = JSON.parse(localStorage.getItem('users') || '{}');
                    
                    // Verificar si el usuario ya existe
                    if (existingUsers[importedData.user]) {
                        // Usuario existe - preguntar si quiere fusionar datos
                        if (confirm(`El usuario "${importedData.user}" ya existe. ¬øQuieres fusionar los datos del archivo con los existentes?\n\n- S√≠: Se a√±adir√°n los nuevos datos\n- No: Se mantendr√°n los datos actuales`)) {
                            // Fusionar favoritos (evitando duplicados)
                            importedData.favorites.forEach(newFav => {
                                const exists = existingUsers[importedData.user].favorites.some(existingFav => 
                                    existingFav.text === newFav.text && existingFav.reference === newFav.reference
                                );
                                if (!exists) {
                                    existingUsers[importedData.user].favorites.push(newFav);
                                }
                            });
                            
                            // Fusionar entradas de diario (evitando duplicados por fecha y texto)
                            importedData.journal.forEach(newEntry => {
                                const exists = existingUsers[importedData.user].journal.some(existingEntry => 
                                    existingEntry.text === newEntry.text && existingEntry.date === newEntry.date
                                );
                                if (!exists) {
                                    existingUsers[importedData.user].journal.push(newEntry);
                                }
                            });
                            
                            showLoadDataMessage('‚ú® ¬°Datos fusionados exitosamente! Ahora puedes iniciar sesi√≥n.', 'success');
                        } else {
                            showLoadDataMessage('Se mantuvieron los datos existentes. Puedes iniciar sesi√≥n normalmente.', 'success');
                        }
                    } else {
                        // Usuario nuevo - crear autom√°ticamente
                        existingUsers[importedData.user] = {
                            username: importedData.user,
                            password: '123456', // Contrase√±a por defecto
                            gender: importedData.gender || 'male',
                            favorites: importedData.favorites || [],
                            journal: importedData.journal || [],
                            lastBackup: new Date().toISOString().split('T')[0]
                        };
                        
                        showLoadDataMessage(`‚ú® ¬°Usuario "${importedData.user}" creado autom√°ticamente! Contrase√±a: 123456 - Puedes cambiarla despu√©s.`, 'success');
                    }
                    
                    // Guardar en localStorage
                    localStorage.setItem('users', JSON.stringify(existingUsers));
                    
                    // Limpiar el campo de archivo
                    fileInput.value = '';
                    rememberImportedFilePath(file);
                    
                    // Mostrar opciones al usuario
                    setTimeout(() => {
                        if (confirm('¬øQuieres iniciar sesi√≥n ahora con los datos cargados?')) {
                            showScreen('login-screen');
                            document.getElementById('login-username').value = importedData.user;
                            document.getElementById('login-password').value = '123456';
                        } else {
                            showLoadDataMessage('Los datos se han guardado. Puedes iniciar sesi√≥n cuando quieras.', 'success');
                        }
                    }, 1000);
                    
                } catch (error) {
                    showLoadDataMessage('Error: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Obtener datos usuario
        function getUserData() {
            if (!currentUser) return { favorites: [], journal: [], lastBackup: null };
            
            const existingUsers = JSON.parse(localStorage.getItem('users') || '{}');
            const user = existingUsers[currentUser.username];
            
            return user || { favorites: [], journal: [], lastBackup: null };
        }

        // Guardar datos usuario
        function saveUserData(userData) {
            if (!currentUser) return;
            
            const existingUsers = JSON.parse(localStorage.getItem('users') || '{}');
            existingUsers[currentUser.username] = {
                ...existingUsers[currentUser.username],
                ...userData
            };
            
            localStorage.setItem('users', JSON.stringify(existingUsers));
        }

        // Mostrar pantalla
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Mostrar mensaje
        function showMessage(message, type) {
            const messageElement = document.getElementById('data-message');
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
            
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 4000);
        }

        // Mostrar mensaje carga datos
        function showLoadDataMessage(message, type) {
            const messageElement = document.getElementById('load-data-message');
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
        }

        // Crear confeti
        function createConfetti(count) {
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = getRandomColor();
                confetti.style.animation = `confettiFall ${1 + Math.random() * 2}s linear forwards`;
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }

        function getRandomColor() {
            const colors = ['#2563EB', '#60A5FA', '#D97706', '#F59E0B', '#10B981', '#EF4444', '#C026D3', '#DB2777'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
    </script>
</body>
</html>